# Изоляция заказов по токенам

## Проблема
Когда пользователь получает новый токен, он видел заказы других пользователей из-за отсутствия правильной изоляции данных.

## Решение
Реализована полная изоляция заказов через поле `team_id`:

### 1. Структура team_id

Каждый пользователь имеет `team_id`:
- **Admin**: `team_id = собственный token`
- **Team Leader**: `team_id = собственный token`
- **Team Member**: `team_id = token тимлида (parent_token)`

### 2. Автоматическая установка team_id

При создании записей автоматически устанавливается `team_id` через триггеры базы данных:

- **Users**: триггер `trg_set_user_team_id` устанавливает `team_id` при создании/обновлении пользователя
- **Orders**: триггер `trg_set_order_team_id` копирует `team_id` создателя в заказ
- **Transactions**: триггер `trg_set_transaction_team_id` копирует `team_id` пользователя
- **Notifications**: триггер `trg_set_notification_team_id` копирует `team_id` пользователя

### 3. Фильтрация данных

При загрузке заказов:
- **Admin** видит все заказы (без фильтра)
- **Остальные** видят только заказы, где `team_id = их team_id`

Код в `App.tsx`:
```typescript
if (userData.role === 'admin') {
  // Загрузка всех заказов
  const { data } = await supabase.from('orders').select('*');
} else {
  // Загрузка только заказов своей команды
  const { data } = await supabase
    .from('orders')
    .select('*')
    .eq('team_id', userTeamId);
}
```

### 4. Создание заказа

При создании нового заказа:
1. Получаем `team_id` текущего пользователя из базы данных
2. Устанавливаем это значение в поле `team_id` заказа
3. Триггер базы данных автоматически проверяет и устанавливает правильный `team_id`

## Результат

✅ Каждый токен видит только свои заказы
✅ Заказы автоматически привязываются к правильному team_id
✅ Администратор видит все заказы
✅ Team Leader и его Team Members видят общие заказы
✅ Разные токены полностью изолированы друг от друга
